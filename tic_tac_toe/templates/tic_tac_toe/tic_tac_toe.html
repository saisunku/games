<html>
    <head>
        <title>Tic Tac Toe</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>

        {% load static %}
        <link rel="stylesheet" href="{% static 'tic_tac_toe/main.css' %}" />
        <script src="{% static 'tic_tac_toe/tic_tac_toe.js' %}"></script>
    </head>

    <body>
        <div class="header">
            <h2><a href=index.html>Sai Sunku</a></h2>
            <a href="https://github.com/saisunku/">GitHub</a> |
            <a href="https://www.linkedin.com/in/saisunku/">LinkedIn</a> |
            <a href=blog.html>Blog</a>
        </div>

        <div class="page_side" id="left_side" style="float: left;">

        <div style="float: left;">
        <h2>Player X</h2>
        <select name="Player X" id="player_X_dropdown">
            <option value="human">Human</option>
        </select>
        </div>
        <div style="float: right;">
        <h2>Player O</h2>
        <select name="Player O" id="player_O_dropdown">
            <option value="minimax">Minimax</option>
            <option value="human">Human</option>
            <option value="random">Random AI</option>
        </select>
        </div>


        <table class="board" id="main_board">
            <tr>
                <td> </td>
                <td class="vert"> </td>
                <td> </td>
            </tr>
             <tr>
                <td class="hori"> </td>
                <td class="vert hori"> </td>
                <td class="hori"> </td>
            </tr>
           <tr>
                <td> </td>
                <td class="vert"> </td>
                <td> </td>
            </tr>
        </table>
        </div>

        <div class="page_side" id="right_side" style="float: right;">
        <div class="tree" style="z-index: 0;">
            <svg id="tree_svg" width="100%" height="500px"></svg>
        </div>

        <div style="z-index: 1; position: absolute; top: 400px; left: 1000px;">
        <table class="board" id="side_board">
            <tr>
                <td> </td>
                <td class="vert"> </td>
                <td> </td>
            </tr>
             <tr>
                <td class="hori"> </td>
                <td class="vert hori"> </td>
                <td class="hori"> </td>
            </tr>
           <tr>
                <td> </td>
                <td class="vert"> </td>
                <td> </td>
            </tr>
        </table>
        </div>
        </div>


        <textarea id="from_server" cols="20" rows = "10"></textarea>
        <button id="reset_button">Reset</button>

        <script>
            let cur_player = 'X';
            const nbsp = String.fromCharCode(160); // charCode 160 is a non-breaking space

            const main_board = document.getElementById('main_board');
            const side_board = document.getElementById('side_board');
            setDefaultBoard(main_board);
            setDefaultBoard(side_board);
            const svg = d3.select("#tree_svg");

            // Connect to server via WebSocket
            const gameSocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/tic_tac_toe/'
            )

            function getAIMove(ai, cur_board) {
                gameSocket.send(JSON.stringify({
                    'cur_player': cur_player,
                    'ai': ai,
                    'cur_board': boardToArray(main_board),
                }))
            }

            gameSocket.onmessage = function(e) {
                // Executes when a message is received from the server
                const game_data = JSON.parse(e.data);
                next_move = game_data.next_move;
                treeData = game_data.tree;

                document.getElementById('from_server').textContent += next_move + '\n';
                drawTree(treeData, svg);

                main_board.rows[next_move[0]].cells[next_move[1]].textContent = cur_player;
                const winner = getWinner(main_board);
                const draw = isFull(main_board);
                if (winner) {
                    document.getElementById('from_server').textContent += cur_player + ' won!\n';
                    // setDefaultBoard(main_board);
                }
                else if (draw) {
                    document.getElementById('from_server').textContent += 'Draw!\n';
                    // setDefaultBoard(main_board);
                }
                else {
                    updatePlayer();
                }
            }

            gameSocket.onclose = function(e) {
                // Executes when the connection closes
                console.error('Chat socket closed unexpectedly');
            };

            // Executes on cell click
            for (let i = 0; i < main_board.rows.length; i++){
                for (let j = 0; j < main_board.rows[i].cells.length; j++){

                    main_board.rows[i].cells[j].onclick = function () {
                        const winner = getWinner(main_board);
                        const draw = isFull(main_board);

                        if (winner) {
                            document.getElementById('from_server').textContent += cur_player + ' won!\n';
                            // setDefaultBoard(main_board);
                        }
                        else if (draw) {
                            document.getElementById('from_server').textContent += 'Draw!\n';
                            // setDefaultBoard(main_board);
                        }
                        else if (main_board.rows[i].cells[j].textContent == nbsp) {
                            main_board.rows[i].cells[j].textContent = cur_player;

                            updatePlayer();

                            const ai = document.getElementById('player_O_dropdown').value;
                            if (ai == 'random' || ai == 'minimax') {
                                // Get next move from server
                                getAIMove(ai, main_board);
                            }
                        }
                    }
                }
            }

            // Reset button
            document.getElementById('reset_button').onclick = function () {
                setDefaultBoard(main_board);
                setDefaultBoard(side_board);
                drawTree(null, svg);
            }

       </script>

        <script src="{% static 'tic_tac_toe/drawTree.js' %}"></script>
    </body>
</html>